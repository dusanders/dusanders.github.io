<!DOCTYPE html>
<html lang="en-US">
<head>
    <link rel="stylesheet" href="../stylesheet.css">

    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="../script.js"></script>
    <title>BTLE RC Car</title>
</head>
<body>
    <div id="background"><img src="androidLanding.png" /></div>
    <div id="textBackground">
    </div>
    <div id="container">
        <div class="content-div">
            <h1 style="text-align:center;">Bluetooth Low Energy RC Car</h1>
            <div><img src="device-2015-01-14-170058.jpg" /></div>
            <p>
                This app was created to control my Bluetooth Low Energy RC Car, which can be reviewed under my <a href="../ASM/ASMBTLE.html" target="_blank">Embedded Systems</a>
                section. The app was required to communicate with the car over Bluetooth Low Energy, which is supported by the Samsung Galaxy S5 Sport that was used
                for this project. The project was a great learning experience, having never worked with Bluetooth Low Energy I was excited to learn the protocol as it is becoming
                ever more popular in todays market.
            </p>
            <div><img src="connected.jpg" /></div>
            <h2>Operation</h2>
            <p>
                The app is designed to use the accelerometer of the phone as the direction input to control the car. This means that the user tilts the phone forward to move in
                a forward direction, tilt backwards to move backwards, and tilt the phone in the respective turning directions. The application starts with a simple UI only consisting
                of a 'Scan' button. Once the scan button is pressed, the phone will scan for any BTLE devices within range and display all found devices within a ListView. The
                BTLE module that was used for the car was able to be programmed with a custom device name and bluetooth-friendly name which shows up once successfully
                found by the phone. Once the user clicks on the car device from the available devices list, the phone connects to the car and if there is a successful connection we start the
                accelerometer sensor, this is all handled by a cutom 'BluetoothGattServerController' class that I created. Once the sensor is started, it begins reading data and sending
                values to the car; this communication is a state-based communication scheme, where the phone will not send a new command until it gets an 'acknowledge' signal
                from the car. The communication is performed with a set of BTLE Characteristics with the app itself serving as the BTLE Service. No encryption is used over the
                BTLE link, neither is pairing performed. The phone automatically reconnect to the car when there is disconnection.
            </p>
            <div class="smallSpace"></div>
            <h2>Starting Procedure</h2>
            <p>
                The app starts all of its required settings within the onCreate() method that is called when the app first launches. This procedure basically loads all the views and
                begins to set up any required listeners. We also set up our BTLE Service in this method; the Service is created and then we create all the required Characteristics and
                add those to the Service. We store these values into an Array that will allow us to pass this Service and its Characteristics to the other classes in the app. We also
                add the 'Scan' button with a click event to start the scanning process.
            </p>
            <div class="codeBox">
                <pre>
<a name="l47"><span class="ln">47   </span></a>    @Override 
<a name="l48"><span class="ln">48   </span></a>    </span><span class="s0">protected void </span><span class="s1">onCreate(Bundle savedInstanceState) { 
<a name="l49"><span class="ln">49   </span></a>        </span><span class="s0">super</span><span class="s1">.onCreate(savedInstanceState)</span><span class="s0">;</span><span class="s1"> 
<a name="l50"><span class="ln">50   </span></a>        mainBundle = savedInstanceState</span><span class="s0">;</span><span class="s1"> 
<a name="l51"><span class="ln">51   </span></a>        setContentView(R.layout.activity_main)</span><span class="s0">;</span><span class="s1"> 
<a name="l52"><span class="ln">52   </span></a>        mActivity = </span><span class="s0">this;</span><span class="s1"> 
<a name="l53"><span class="ln">53   </span></a>        mTextView1 = (TextView) findViewById(R.id.textView1)</span><span class="s0">;</span><span class="s1"> 
<a name="l54"><span class="ln">54   </span></a>        mTextView2 = (TextView) findViewById(R.id.textView2)</span><span class="s0">;</span><span class="s1"> 
<a name="l55"><span class="ln">55   </span></a>        mScanBluetooth = (Button) findViewById(R.id.scanBluetooth)</span><span class="s0">;</span><span class="s1"> 
<a name="l56"><span class="ln">56   </span></a>        mBluetoothListView = (ListView) findViewById(R.id.bluetoothListView)</span><span class="s0">;</span><span class="s1"> 
<a name="l57"><span class="ln">57   </span></a>        mBluetoothDeviceList = </span><span class="s0">new </span><span class="s1">ArrayList&lt;BluetoothDevice&gt;()</span><span class="s0">;</span><span class="s1"> 
<a name="l58"><span class="ln">58   </span></a>        mBluetoothListAdapter = </span><span class="s0">new </span><span class="s1">BluetoothListAdapter(mActivity.getApplicationContext()</span><span class="s0">, </span><span class="s1">R.layout.list_item</span><span class="s0">, </span><span class="s1">mBluetoothDeviceList)</span><span class="s0">;</span><span class="s1"> 
<a name="l59"><span class="ln">59   </span></a>        mBluetoothListView.setAdapter(mBluetoothListAdapter)</span><span class="s0">;</span><span class="s1"> 
<a name="l60"><span class="ln">60   </span></a> 
<a name="l61"><span class="ln">61   </span></a>        mBluetoothManager = (BluetoothManager) getSystemService(BLUETOOTH_SERVICE)</span><span class="s0">;</span><span class="s1"> 
<a name="l62"><span class="ln">62   </span></a>        mBluetoothAdapter = mBluetoothManager.getAdapter()</span><span class="s0">;</span><span class="s1"> 
<a name="l63"><span class="ln">63   </span></a> 
<a name="l64"><span class="ln">64   </span></a>        mService = </span><span class="s0">new </span><span class="s1">BluetoothGattService(mUUID[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">BluetoothGattService.SERVICE_TYPE_PRIMARY)</span><span class="s0">;</span><span class="s1"> 
<a name="l65"><span class="ln">65   </span></a> 
<a name="l66"><span class="ln">66   </span></a>        mCharacteristics = </span><span class="s0">new </span><span class="s1">ArrayList&lt;BluetoothGattCharacteristic&gt;()</span><span class="s0">;</span><span class="s1"> 
<a name="l67"><span class="ln">67   </span></a>        </span><span class="s4">//add 'forward' characteristic</span><span class="s1"> 
<a name="l68"><span class="ln">68   </span></a>        BluetoothGattCharacteristic characteristic1 = </span><span class="s0">new </span><span class="s1">BluetoothGattCharacteristic(mUUID[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PROPERTY_READ</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PERMISSION_READ)</span><span class="s0">;</span><span class="s1"> 
<a name="l69"><span class="ln">69   </span></a>        </span><span class="s4">//add 'backwards' characteristic</span><span class="s1"> 
<a name="l70"><span class="ln">70   </span></a>        BluetoothGattCharacteristic characteristic2 = </span><span class="s0">new </span><span class="s1">BluetoothGattCharacteristic(mUUID[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PROPERTY_READ</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PERMISSION_READ)</span><span class="s0">;</span><span class="s1"> 
<a name="l71"><span class="ln">71   </span></a>        </span><span class="s4">//add 'left' characteristic</span><span class="s1"> 
<a name="l72"><span class="ln">72   </span></a>        BluetoothGattCharacteristic characteristic3 = </span><span class="s0">new </span><span class="s1">BluetoothGattCharacteristic(mUUID[</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PROPERTY_READ</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PERMISSION_READ)</span><span class="s0">;</span><span class="s1"> 
<a name="l73"><span class="ln">73   </span></a>        </span><span class="s4">//add 'right characteristic</span><span class="s1"> 
<a name="l74"><span class="ln">74   </span></a>        BluetoothGattCharacteristic characteristic4 = </span><span class="s0">new </span><span class="s1">BluetoothGattCharacteristic(mUUID[</span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PROPERTY_READ</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PERMISSION_READ)</span><span class="s0">;</span><span class="s1"> 
<a name="l75"><span class="ln">75   </span></a>        </span><span class="s4">//add the ACK Characteristic</span><span class="s1"> 
<a name="l76"><span class="ln">76   </span></a>        BluetoothGattCharacteristic characteristic5 = </span><span class="s0">new </span><span class="s1">BluetoothGattCharacteristic(mUUID[</span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PROPERTY_WRITE_NO_RESPONSE</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic.PERMISSION_WRITE)</span><span class="s0">;</span><span class="s1"> 
<a name="l77"><span class="ln">77   </span></a>        mCharacteristics.add(characteristic1)</span><span class="s0">;</span><span class="s1"> 
<a name="l78"><span class="ln">78   </span></a>        mCharacteristics.add(characteristic2)</span><span class="s0">;</span><span class="s1"> 
<a name="l79"><span class="ln">79   </span></a>        mCharacteristics.add(characteristic3)</span><span class="s0">;</span><span class="s1"> 
<a name="l80"><span class="ln">80   </span></a>        mCharacteristics.add(characteristic4)</span><span class="s0">;</span><span class="s1"> 
<a name="l81"><span class="ln">81   </span></a>        mCharacteristics.add(characteristic5)</span><span class="s0">;</span><span class="s1"> 
<a name="l82"><span class="ln">82   </span></a> 
<a name="l83"><span class="ln">83   </span></a>        mService.addCharacteristic(mCharacteristics.get(</span><span class="s3">0</span><span class="s1">))</span><span class="s0">;</span><span class="s1"> 
<a name="l84"><span class="ln">84   </span></a>        mService.addCharacteristic(mCharacteristics.get(</span><span class="s3">1</span><span class="s1">))</span><span class="s0">;</span><span class="s1"> 
<a name="l85"><span class="ln">85   </span></a>        mService.addCharacteristic(mCharacteristics.get(</span><span class="s3">2</span><span class="s1">))</span><span class="s0">;</span><span class="s1"> 
<a name="l86"><span class="ln">86   </span></a>        mService.addCharacteristic(mCharacteristics.get(</span><span class="s3">3</span><span class="s1">))</span><span class="s0">;</span><span class="s1"> 
<a name="l87"><span class="ln">87   </span></a>        mService.addCharacteristic(mCharacteristics.get(</span><span class="s3">4</span><span class="s1">))</span><span class="s0">;</span><span class="s1"> 
<a name="l88"><span class="ln">88   </span></a> 
<a name="l89"><span class="ln">89   </span></a>        mGattServerController = </span><span class="s0">new </span><span class="s1">BluetoothGattServerController(mBluetoothManager</span><span class="s0">, </span><span class="s1">mActivity</span><span class="s0">, </span><span class="s1">mCharacteristics</span><span class="s0">, </span><span class="s1">mService)</span><span class="s0">;</span><span class="s1"> 
<a name="l90"><span class="ln">90   </span></a> 
<a name="l91"><span class="ln">91   </span></a>        mScanBluetooth.setOnClickListener(</span><span class="s0">new </span><span class="s1">View.OnClickListener() { 
<a name="l92"><span class="ln">92   </span></a>            @Override 
<a name="l93"><span class="ln">93   </span></a>            </span><span class="s0">public void </span><span class="s1">onClick(View view) { 
<a name="l94"><span class="ln">94   </span></a>                </span><span class="s0">final </span><span class="s1">BluetoothLeScanCallback mLeScanCallback = </span><span class="s0">new </span><span class="s1">BluetoothLeScanCallback(mActivity)</span><span class="s0">;</span><span class="s1"> 
<a name="l95"><span class="ln">95   </span></a>                </span><span class="s0">final long </span><span class="s1">SCAN_PERIOD = </span><span class="s3">1000</span><span class="s0">;</span><span class="s1"> 
<a name="l96"><span class="ln">96   </span></a>                Handler scannerHandler = </span><span class="s0">new </span><span class="s1">Handler()</span><span class="s0">;</span><span class="s1"> 
<a name="l97"><span class="ln">97   </span></a>                scannerHandler.postDelayed(</span><span class="s0">new </span><span class="s1">Runnable() { 
<a name="l98"><span class="ln">98   </span></a>                    @Override 
<a name="l99"><span class="ln">99   </span></a>                    </span><span class="s0">public void </span><span class="s1">run() { 
<a name="l100"><span class="ln">100  </span></a>                        mBluetoothAdapter.stopLeScan(mLeScanCallback)</span><span class="s0">;</span><span class="s1"> 
<a name="l101"><span class="ln">101  </span></a>                    } 
<a name="l102"><span class="ln">102  </span></a>                }</span><span class="s0">, </span><span class="s1">SCAN_PERIOD)</span><span class="s0">;</span><span class="s1"> 
<a name="l103"><span class="ln">103  </span></a>                mBluetoothAdapter.startLeScan(mLeScanCallback)</span><span class="s0">;</span><span class="s1"> 
<a name="l104"><span class="ln">104  </span></a>            } 
<a name="l105"><span class="ln">105  </span></a>        })</span><span class="s0">;</span><span class="s1"> 
<a name="l106"><span class="ln">106  </span></a> 
<a name="l107"><span class="ln">107  </span></a>    } 
<a name="l108"><span class="ln">108  </span></a> 
</pre><div class="caption">Here we see the 'onCreate()' method that is called when the app is first started. We initialize our Service and populate it with all required characteristics.</div>
            </div>
            <div class="smallSpace"></div>
            <h2>Handle BTLE Scan</h2>
            <p>
                The app scans for BTLE devices once the 'Scan' button has been pressed, this starts the <a href="http://developer.android.com/reference/android/bluetooth/BluetoothAdapter.html" target="_blank"> BluetoothAdapter.startLeScan() </a>
                process which scans for new devices. The scanning process is handled with a post delayed <a href="http://developer.android.com/reference/java/lang/Runnable.html" target="_blank">Runnable</a>
                so that it can scan in a seperate Thread and not lock the UI. The scanning is stopped by this delayed Runnable when it calls the BluetoothAdapter.stopLeScan() method
                on the created mBluetoothAdapter object (we scan for one second). This can be seen in the above 'onCreate()' method.
            </p>
            <p>
                If the BluetoothAdapter scan returns a device, the Android system will look for a <a href="https://developer.android.com/reference/android/bluetooth/BluetoothAdapter.LeScanCallback.html" target="_blank"> BluetoothAdapter.LeScanCallback</a>
                object. This object is provided in my app by creating a class, 'BluetoothLeScanCallback.class', which implements the required object. The created class simply
                updates the main UI list view to add the device for viewing by the user.
            </p>
            <div class="codeBox">
                <pre>
<a name="l10"><span class="ln">10   </span></a></span><span class="s0">public class </span><span class="s1">BluetoothLeScanCallback </span><span class="s0">implements </span><span class="s1">BluetoothAdapter.LeScanCallback { 
<a name="l11"><span class="ln">11   </span></a>    </span><span class="s0">private </span><span class="s1">Activity lActivity</span><span class="s0">;</span><span class="s1"> 
<a name="l12"><span class="ln">12   </span></a>    </span><span class="s0">public </span><span class="s1">BluetoothLeScanCallback (Activity activity) { 
<a name="l13"><span class="ln">13   </span></a>        lActivity = activity</span><span class="s0">;</span><span class="s1"> 
<a name="l14"><span class="ln">14   </span></a>    } 
<a name="l15"><span class="ln">15   </span></a>    @Override 
<a name="l16"><span class="ln">16   </span></a>    </span><span class="s0">public void </span><span class="s1">onLeScan(</span><span class="s0">final </span><span class="s1">BluetoothDevice bluetoothDevice</span><span class="s0">, int </span><span class="s1">i</span><span class="s0">, byte</span><span class="s1">[] bytes) { 
<a name="l17"><span class="ln">17   </span></a>        lActivity.runOnUiThread(</span><span class="s0">new </span><span class="s1">Runnable() { 
<a name="l18"><span class="ln">18   </span></a>            @Override 
<a name="l19"><span class="ln">19   </span></a>            </span><span class="s0">public void </span><span class="s1">run() { 
<a name="l20"><span class="ln">20   </span></a>                MainActivity.addBluetoothDevice(bluetoothDevice)</span><span class="s0">;</span><span class="s1"> 
<a name="l21"><span class="ln">21   </span></a>            } 
<a name="l22"><span class="ln">22   </span></a>        })</span><span class="s0">;</span><span class="s1"> 
<a name="l23"><span class="ln">23   </span></a>    } 
<a name="l24"><span class="ln">24   </span></a>} 
</pre><div class="caption">
                    Here we see the entire 'BluetoothLeScanCallback.class' object that implements BluetoothAdapter.LeScanCallback so we can update our
                    main UI when a BTLE device is found.
                </div>
            </div>
            <div class="space"></div>
            <p>
                The BluetoothLeScanCallback class calls on the MainActivity class for a method, 'addBluetoothDevice' which in turn updates our ListView's ListAdapter class
                that was created to handle our BTLE device list.
            </p>
            <div class="codeBox">
                <pre>
<a name="l108"><span class="ln">108  </span></a> 
<a name="l109"><span class="ln">109  </span></a>    </span><span class="s0">public static void </span><span class="s1">addBluetoothDevice(BluetoothDevice inDevice) { 
<a name="l110"><span class="ln">110  </span></a>        </span><span class="s0">if </span><span class="s1">(mBluetoothDeviceList.isEmpty()) { 
<a name="l111"><span class="ln">111  </span></a>            mBluetoothDeviceList.add(inDevice)</span><span class="s0">;</span><span class="s1"> 
<a name="l112"><span class="ln">112  </span></a>            mBluetoothListAdapter.notifyDataSetChanged()</span><span class="s0">;</span><span class="s1"> 
<a name="l113"><span class="ln">113  </span></a>        } 
<a name="l114"><span class="ln">114  </span></a>        </span><span class="s0">if </span><span class="s1">(!mBluetoothDeviceList.isEmpty()) { 
<a name="l115"><span class="ln">115  </span></a>            </span><span class="s0">if </span><span class="s1">(!mBluetoothDeviceList.contains(inDevice)) { 
<a name="l116"><span class="ln">116  </span></a>                mBluetoothDeviceList.add(inDevice)</span><span class="s0">;</span><span class="s1"> 
<a name="l117"><span class="ln">117  </span></a>                mBluetoothListAdapter.notifyDataSetChanged()</span><span class="s0">;</span><span class="s1"> 
<a name="l118"><span class="ln">118  </span></a>            } 
<a name="l119"><span class="ln">119  </span></a>        } 
<a name="l120"><span class="ln">120  </span></a>    } 
<a name="l121"><span class="ln">121  </span></a> 
</pre><div class="caption">
                    Here we see the method; 'addBluetoothDevice' which is called when the system calls our BluetoothLeScanCallback class. This notifies our
                    ListAdapter that we have new objects in the list and the view must be updated.
                </div>
            </div>
        <div class="smallSpace"></div>
            <p>The ListAdapter that we use will handle the click events that happen on a Bluetooth Device that is displayed on the ListView. This ListAdapter calls another
            MainActivity method; 'startGattServer()' that expects a Bluetooth Device and starts the process of connecting to the specified Bluetooth Device.</p>
            <div class="codeBox">
                <pre>
<a name="l20"><span class="ln">20   </span></a></span><span class="s0">public class </span><span class="s1">BluetoothListAdapter </span><span class="s0">extends </span><span class="s1">ArrayAdapter&lt;BluetoothDevice&gt; { 
<a name="l21"><span class="ln">21   </span></a>    </span><span class="s0">private </span><span class="s1">List&lt;BluetoothDevice&gt; aDeviceList</span><span class="s0">;</span><span class="s1"> 
<a name="l22"><span class="ln">22   </span></a>    </span><span class="s0">private </span><span class="s1">Context aContext</span><span class="s0">;</span><span class="s1"> 
<a name="l23"><span class="ln">23   </span></a> 
<a name="l24"><span class="ln">24   </span></a>    </span><span class="s0">public </span><span class="s1">BluetoothListAdapter(Context context</span><span class="s0">, int </span><span class="s1">resource</span><span class="s0">, </span><span class="s1">List&lt;BluetoothDevice&gt; objects) { 
<a name="l25"><span class="ln">25   </span></a>        </span><span class="s0">super</span><span class="s1">(context</span><span class="s0">, </span><span class="s1">resource</span><span class="s0">, </span><span class="s1">objects)</span><span class="s0">;</span><span class="s1"> 
<a name="l26"><span class="ln">26   </span></a>        aDeviceList = objects</span><span class="s0">;</span><span class="s1"> 
<a name="l27"><span class="ln">27   </span></a>        aContext = context</span><span class="s0">;</span><span class="s1"> 
<a name="l28"><span class="ln">28   </span></a>    } 
<a name="l29"><span class="ln">29   </span></a> 
<a name="l30"><span class="ln">30   </span></a>    @Override 
<a name="l31"><span class="ln">31   </span></a>    </span><span class="s0">public </span><span class="s1">View getView(</span><span class="s0">final int </span><span class="s1">position</span><span class="s0">, </span><span class="s1">View convertView</span><span class="s0">, </span><span class="s1">ViewGroup parent) { 
<a name="l32"><span class="ln">32   </span></a>        LayoutInflater inflater = (LayoutInflater)aContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE)</span><span class="s0">;</span><span class="s1"> 
<a name="l33"><span class="ln">33   </span></a>        View listItem = inflater.inflate(R.layout.list_item</span><span class="s0">, </span><span class="s1">parent</span><span class="s0">, false</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
<a name="l34"><span class="ln">34   </span></a>        TextView bluetoothDeviceName = (TextView)listItem.findViewById(R.id.bluetoothDeviceName)</span><span class="s0">;</span><span class="s1"> 
<a name="l35"><span class="ln">35   </span></a>        Button connectButton = (Button)listItem.findViewById(R.id.connectButton)</span><span class="s0">;</span><span class="s1"> 
<a name="l36"><span class="ln">36   </span></a>        MainActivity.connectionView = (TextView)listItem.findViewById(R.id.connectionStateView)</span><span class="s0">;</span><span class="s1"> 
<a name="l37"><span class="ln">37   </span></a>        </span><span class="s0">if</span><span class="s1">(!aDeviceList.isEmpty()) { 
<a name="l38"><span class="ln">38   </span></a>            bluetoothDeviceName.setText(aDeviceList.get(position).getName() + </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s1">+ aDeviceList.get(position).getAddress())</span><span class="s0">;</span><span class="s1"> 
<a name="l39"><span class="ln">39   </span></a>            connectButton.setOnClickListener(</span><span class="s0">new </span><span class="s1">View.OnClickListener() { 
<a name="l40"><span class="ln">40   </span></a>                @Override 
<a name="l41"><span class="ln">41   </span></a>                </span><span class="s0">public void </span><span class="s1">onClick(View view) { 
<a name="l42"><span class="ln">42   </span></a>                    MainActivity.startGattServer(aDeviceList.get(position))</span><span class="s0">;</span><span class="s1"> 
<a name="l43"><span class="ln">43   </span></a>                } 
<a name="l44"><span class="ln">44   </span></a>            })</span><span class="s0">;</span><span class="s1"> 
<a name="l45"><span class="ln">45   </span></a>        } 
<a name="l46"><span class="ln">46   </span></a>        </span><span class="s0">return </span><span class="s1">listItem</span><span class="s0">;</span><span class="s1"> 
<a name="l47"><span class="ln">47   </span></a>    } 
<a name="l48"><span class="ln">48   </span></a>    @Override 
<a name="l49"><span class="ln">49   </span></a>    </span><span class="s0">public </span><span class="s1">BluetoothDevice getItem(</span><span class="s0">int </span><span class="s1">position){ 
<a name="l50"><span class="ln">50   </span></a>        </span><span class="s0">return </span><span class="s1">aDeviceList.get(position)</span><span class="s0">;</span><span class="s1"> 
<a name="l51"><span class="ln">51   </span></a>    } 
<a name="l52"><span class="ln">52   </span></a>} 
</pre><div class="caption">Here we see the entire ListAdapter that was created to handle the objects displayed in the ListView of the UI.</div>
            </div>
            <div class="space"></div>
            <h2>BTLE Communication</h2>
            <p>
                The ListAdapter will call on the MainActivity method, 'startGattServer()' which is responsible for connecting to the specified BluetoothDevice. This button also should
                act as an on/off button in the case that we wish disconnect from the specific BluetoothDevice. We accomplish this by checking whether we are currently connected
                at the time the button is pressed, if we are, then we disconnect from the specified device; otherwise we connect to the device.
            </p>
            <div class="codeBox">
                <pre>
<a name="l143"><span class="ln">143  </span></a> 
<a name="l144"><span class="ln">144  </span></a>    </span><span class="s0">public static void </span><span class="s1">startGattServer(</span><span class="s0">final </span><span class="s1">BluetoothDevice inBluetoothDevice) { 
<a name="l145"><span class="ln">145  </span></a>        </span><span class="s0">if</span><span class="s1">(mGattServerController.isConnected()){ 
<a name="l146"><span class="ln">146  </span></a>            mGattServerController.disconnect(inBluetoothDevice)</span><span class="s0">;</span><span class="s1"> 
<a name="l147"><span class="ln">147  </span></a>        } 
<a name="l148"><span class="ln">148  </span></a>        mGattServerController.connect(inBluetoothDevice</span><span class="s0">, true</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
<a name="l149"><span class="ln">149  </span></a>    } 
<a name="l150"><span class="ln">150  </span></a>} 
<a name="l151"><span class="ln">151  </span></a> 
</pre><div class="caption">Here we see the 'startGattServer()' method within MainActivity.class, this is called when a user clicks on a Bluetooth Device from the main UI.</div>
            </div>
            <div class="smallSpace"></div>
            <p>The 'startGattServer()' method calls 'connect()' on the specified device if we are currently not connected. This method is part of the BluetoothGattServerController 
            class that was created to handle the events of the Android <a href="https://developer.android.com/reference/android/bluetooth/BluetoothGattServerCallback.html"target="_blank">BluetoothGattServerCallback</a> 
            which sends the app BTLE data that is received. The created class opens a <a href="https://developer.android.com/reference/android/bluetooth/BluetoothGattServer.html"target="_blank">BluetoothGattServer</a> 
            which will require a GattServerCallback when created. The class creates this callback when it creates the BluetoothGattServer object; we do not need a valid BluetoothDevice to 
            open the BluetoothGattServer, so this is created with our 'onCreate()' method in MainActivity.class</p>
            <div class="codeBox">
                <pre>
<a name="l40"><span class="ln">40   </span></a> 
<a name="l41"><span class="ln">41   </span></a>    </span><span class="s0">public </span><span class="s1">BluetoothGattServerController(BluetoothManager inManager</span><span class="s0">, final </span><span class="s1">Activity inActivity</span><span class="s0">, </span><span class="s1">ArrayList&lt;BluetoothGattCharacteristic&gt; inCharacteristics</span><span class="s0">, </span><span class="s1">BluetoothGattService inService) { 
<a name="l42"><span class="ln">42   </span></a>        manager = inManager</span><span class="s0">;</span><span class="s1"> 
<a name="l43"><span class="ln">43   </span></a>        activity = inActivity</span><span class="s0">;</span><span class="s1"> 
<a name="l44"><span class="ln">44   </span></a>        characteristics = inCharacteristics</span><span class="s0">;</span><span class="s1"> 
<a name="l45"><span class="ln">45   </span></a>        gattService = inService</span><span class="s0">;</span><span class="s1"> 
<a name="l46"><span class="ln">46   </span></a>        gattServerController = </span><span class="s0">this;</span><span class="s1"> 
<a name="l47"><span class="ln">47   </span></a>        clearToSend = </span><span class="s0">false;</span><span class="s1"> 
<a name="l48"><span class="ln">48   </span></a>        gattServer = manager.openGattServer(activity</span><span class="s0">, new </span><span class="s1">BluetoothGattServerCallback() { 
<a name="l49"><span class="ln">49   </span></a> 
<a name="l50"><span class="ln">50   </span></a> 
<a name="l51"><span class="ln">51   </span></a>            @Override 
<a name="l52"><span class="ln">52   </span></a>            </span><span class="s0">public void </span><span class="s1">onConnectionStateChange(</span><span class="s0">final </span><span class="s1">BluetoothDevice device</span><span class="s0">, int </span><span class="s1">status</span><span class="s0">, final int </span><span class="s1">newState) { 
<a name="l53"><span class="ln">53   </span></a>                </span><span class="s0">super</span><span class="s1">.onConnectionStateChange(device</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">newState)</span><span class="s0">;</span><span class="s1"> 
<a name="l54"><span class="ln">54   </span></a>                </span><span class="s0">if</span><span class="s1">(newState == </span><span class="s3">2</span><span class="s1">) { 
<a name="l55"><span class="ln">55   </span></a>                    activity.runOnUiThread(</span><span class="s0">new </span><span class="s1">Runnable() { 
<a name="l56"><span class="ln">56   </span></a>                        @Override 
<a name="l57"><span class="ln">57   </span></a>                        </span><span class="s0">public void </span><span class="s1">run() { 
<a name="l58"><span class="ln">58   </span></a>                            MainActivity.connectionView.setText(</span><span class="s4">&quot;Connected&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
<a name="l59"><span class="ln">59   </span></a>                        } 
<a name="l60"><span class="ln">60   </span></a>                    })</span><span class="s0">;</span><span class="s1"> 
</pre><div class="caption">Here we see part of the constructor for the BluetoothGattServerController object. The constructor also acts as the constructor for the 
                BluetoothGattServerCallback object that is required when we open a BluetoothGattServer.</div>
            </div>
            <div class="smallSpace"></div>
            <p>The BluetoothGattServerController class also contains a method, 'notifyCharacteristic' that will be called by the sensor to update a Characteristic when we get
            a user input. This method calls on the BluetoothGattServer object to notify any connected devices that the Characteristic's value has changed. This will be received 
            by our car device.</p>
            <div class="codeBox">
                <pre>
<a name="l151"><span class="ln">151  </span></a> 
<a name="l152"><span class="ln">152  </span></a>    </span><span class="s0">public boolean </span><span class="s1">notifyCharacteristic(BluetoothGattCharacteristic inCharacteristic) { 
<a name="l153"><span class="ln">153  </span></a>        gattServer.notifyCharacteristicChanged(bluetoothDevice</span><span class="s0">, </span><span class="s1">inCharacteristic</span><span class="s0">, true</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
<a name="l154"><span class="ln">154  </span></a>            clearToSend = </span><span class="s0">false;</span><span class="s1"> 
<a name="l155"><span class="ln">155  </span></a>            </span><span class="s0">return true;</span><span class="s1"> 
<a name="l156"><span class="ln">156  </span></a>    } 
<a name="l157"><span class="ln">157  </span></a> 
</pre><div class="caption">Here we see the method that will notify our devices of a changed Characteristic. Also not the change in the class member 'clearToSend', this
                member is the state variable for our communication.</div>
            </div>
            <div class="smallSpace"></div>
            <p>The 'clearToSend' class member is also changed when a Characteristic is changed, this would be our state variable for the communication scheme. When
            we change a Characteristic, we set our 'ACK' state to false and check against this before we try to change another Characteristic. Once the device we are connected
            to responds with a proper 'ACK' signal, we set our 'ACK' state to true and notify the sensor that the device is ready for another command.</p>
            <div class="codeBox">
                <pre>
<a name="l102"><span class="ln">102  </span></a> 
<a name="l103"><span class="ln">103  </span></a>            @Override 
<a name="l104"><span class="ln">104  </span></a>            </span><span class="s0">public void </span><span class="s1">onCharacteristicWriteRequest(BluetoothDevice device</span><span class="s0">, final int </span><span class="s1">requestId</span><span class="s0">, final </span><span class="s1">BluetoothGattCharacteristic characteristic</span><span class="s0">, final boolean </span><span class="s1">preparedWrite</span><span class="s0">, boolean </span><span class="s1">responseNeeded</span><span class="s0">, int </span><span class="s1">offset</span><span class="s0">, byte</span><span class="s1">[] value) { 
<a name="l105"><span class="ln">105  </span></a>                </span><span class="s0">super</span><span class="s1">.onCharacteristicWriteRequest(device</span><span class="s0">, </span><span class="s1">requestId</span><span class="s0">, </span><span class="s1">characteristic</span><span class="s0">, </span><span class="s1">preparedWrite</span><span class="s0">, </span><span class="s1">responseNeeded</span><span class="s0">, </span><span class="s1">offset</span><span class="s0">, </span><span class="s1">value)</span><span class="s0">;</span><span class="s1"> 
<a name="l106"><span class="ln">106  </span></a>                    clearToSend = </span><span class="s0">true;</span><span class="s1"> 
<a name="l107"><span class="ln">107  </span></a>                    sensorController.notifyClearToSend()</span><span class="s0">;</span><span class="s1"> 
<a name="l108"><span class="ln">108  </span></a>            } 
<a name="l109"><span class="ln">109  </span></a> 
</pre><div class="caption">Here is the method that is called when the connected device sends us an 'ACK' signal. For simplicity I have my device write an 
                arbitrary value to a Characteristic.</div>
            </div>
            <div class="space"></div>
            <h2>Sensor Events</h2>
            <p>
                The app contains a class that I made, 'SensorController', which is responsible for all of the sensor events of the accelerometer. The controller is created by the 
                BluetoothGattServerController class when a successfull connection is made to a device, the SensorController class implements SensorEvenListener, so the 
                accelerometer sensor is opened within the 'BluetoothGattServerController' class and is registered to the 'SensorController' class. This means the SensorController
                class will recieve all system broadcasts when the opened sensor sends out new data. We also include a private class 'Command' that will allow us to build a 
                'buffer' of events in the case that we would wish to buffer the events. My implementation simply checks for the ACK and skips sending a new value if we did not recieve ACK.
            </p>
            <div class="codeBox">
                <pre>
<a name="l20"><span class="ln">20   </span></a></span><span class="s0">public class </span><span class="s1">SensorController </span><span class="s0">implements </span><span class="s1">SensorEventListener { 
<a name="l21"><span class="ln">21   </span></a>    </span><span class="s0">private class </span><span class="s1">Command{ 
<a name="l22"><span class="ln">22   </span></a>        </span><span class="s0">public byte</span><span class="s1">[] value</span><span class="s0">;</span><span class="s1"> 
<a name="l23"><span class="ln">23   </span></a>        </span><span class="s0">public </span><span class="s1">BluetoothGattCharacteristic characteristic</span><span class="s0">;</span><span class="s1"> 
<a name="l24"><span class="ln">24   </span></a>        </span><span class="s0">public </span><span class="s1">Command(</span><span class="s0">byte</span><span class="s1">[] inValue</span><span class="s0">, </span><span class="s1">BluetoothGattCharacteristic inCharacteristic){ 
<a name="l25"><span class="ln">25   </span></a>            value = inValue</span><span class="s0">;</span><span class="s1"> 
<a name="l26"><span class="ln">26   </span></a>            characteristic = inCharacteristic</span><span class="s0">;</span><span class="s1"> 
<a name="l27"><span class="ln">27   </span></a>        } 
<a name="l28"><span class="ln">28   </span></a>    } 
</pre><div class="caption">Here we see the SensorController definition, with the Command class for storing our events into a buffer.</div>
            </div>
            <div class="smallSpace"></div>
            <div class="codeBox">
                <pre>
<a name="l36"><span class="ln">36   </span></a> 
<a name="l37"><span class="ln">37   </span></a>    </span><span class="s0">public </span><span class="s1">SensorController(Activity inActivity</span><span class="s0">, </span><span class="s1">BluetoothGattServerController inGattServerController</span><span class="s0">, </span><span class="s1">ArrayList&lt;BluetoothGattCharacteristic&gt; inCharacteristic</span><span class="s0">, </span><span class="s1">BluetoothDevice inDevice) { 
<a name="l38"><span class="ln">38   </span></a>        activity = inActivity</span><span class="s0">;</span><span class="s1"> 
<a name="l39"><span class="ln">39   </span></a>        gattServerController = inGattServerController</span><span class="s0">;</span><span class="s1"> 
<a name="l40"><span class="ln">40   </span></a>        characteristics = inCharacteristic</span><span class="s0">;</span><span class="s1"> 
<a name="l41"><span class="ln">41   </span></a>        device = inDevice</span><span class="s0">;</span><span class="s1"> 
<a name="l42"><span class="ln">42   </span></a>        commandBuffer = </span><span class="s0">new </span><span class="s1">ArrayList&lt;Command&gt;()</span><span class="s0">;</span><span class="s1"> 
<a name="l43"><span class="ln">43   </span></a>    } 
</pre><div class="caption">Here we see the constructor for the SensorController class along with the creation of our buffer.</div>
            </div>
            <div class="smallSpace"></div>
            <p>
                The SensorController checks whether the BluetoothGattServerController is in ACK'd state and is ready to send another command; if the BluetoothGattServerController
                responds with an ACK'd state, then we proceed and send the command to the device. Otherwise we could buffer the command and it will get passed when the 
                BluetoothGattServerController calls our 'notifyClearToSend' method that will send the oldest command within the buffer. 
            </p>
            <div class="codeBoxN">
                <pre><span class="sc11">@Override</span><span class="sc0">
    </span><span class="sc16">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">onSensorChanged</span><span class="sc10">(</span><span class="sc11">SensorEvent</span><span class="sc0"> </span><span class="sc11">sensorEvent</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">//get the values from the sensor
</span><span class="sc0">        </span><span class="sc16">float</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">values</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sensorEvent</span><span class="sc10">.</span><span class="sc11">values</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc2">//parse the proper coordinates from the returned array.
</span><span class="sc0">        </span><span class="sc11">Integer</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">values</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc2">// x plane always 0 index
</span><span class="sc0">        </span><span class="sc11">Integer</span><span class="sc0"> </span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">values</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc2">// y plane always 1 index
</span><span class="sc0">        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">z</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">values</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc2">// z plane always 2 index
</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">stopX</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">//set the values and stopX, as we got a 0 value from sensor,
</span><span class="sc0">            </span><span class="sc2">//stopX will be sent to true so don't continually send '0' to car. only need to send
</span><span class="sc0">            </span><span class="sc2">//once.
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">gattServerController</span><span class="sc10">.</span><span class="sc11">clearToSend</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">characteristics</span><span class="sc10">.</span><span class="sc11">get</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">).</span><span class="sc11">setValue</span><span class="sc10">(</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[]{</span><span class="sc11">x</span><span class="sc10">.</span><span class="sc11">byteValue</span><span class="sc10">()});</span><span class="sc0">
                </span><span class="sc11">gattServerController</span><span class="sc10">.</span><span class="sc11">notifyCharacteristic</span><span class="sc10">(</span><span class="sc11">characteristics</span><span class="sc10">.</span><span class="sc11">get</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">));</span><span class="sc0">
                </span><span class="sc11">stopX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">//create Command object to hold update value
</span><span class="sc0">             </span><span class="sc11">Command</span><span class="sc0"> </span><span class="sc11">command</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Command</span><span class="sc10">(</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[]{</span><span class="sc11">x</span><span class="sc10">.</span><span class="sc11">byteValue</span><span class="sc10">()},</span><span class="sc0"> </span><span class="sc11">characteristics</span><span class="sc10">.</span><span class="sc11">get</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc2">//wait for ACK signal, or timeout
</span><span class="sc0">            </span><span class="sc2">//we got an acceptable command to move, so switch our stopX to allow
</span><span class="sc0">            </span><span class="sc2">// sending a new '0' value when we are requested to stop.
</span><span class="sc0">             </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">gattServerController</span><span class="sc10">.</span><span class="sc11">clearToSend</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                 </span><span class="sc2">//update Command object's characteristic value &amp; notify of change
</span><span class="sc0">                 </span><span class="sc11">command</span><span class="sc10">.</span><span class="sc11">characteristic</span><span class="sc10">.</span><span class="sc11">setValue</span><span class="sc10">(</span><span class="sc11">command</span><span class="sc10">.</span><span class="sc11">value</span><span class="sc10">);</span><span class="sc0">
                 </span><span class="sc2">//gattServerController.notifyCharacteristic(characteristics.get(1));
</span><span class="sc0">                 </span><span class="sc11">gattServerController</span><span class="sc10">.</span><span class="sc11">notifyCharacteristic</span><span class="sc10">(</span><span class="sc11">command</span><span class="sc10">.</span><span class="sc11">characteristic</span><span class="sc10">);</span><span class="sc0">
                 </span><span class="sc11">stopX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">//reset or stop, we are moving now so the next '0' will need to
</span><span class="sc0">                                    </span><span class="sc2">//be sent.
</span><span class="sc0">             </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">//phone axis returns negative, we need absolute value for car.
</span><span class="sc0">            </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Math</span><span class="sc10">.</span><span class="sc11">abs</span><span class="sc10">(</span><span class="sc11">x</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">//create the Command object
</span><span class="sc0">            </span><span class="sc11">Command</span><span class="sc0"> </span><span class="sc11">command</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Command</span><span class="sc10">(</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">x</span><span class="sc10">.</span><span class="sc11">byteValue</span><span class="sc10">()},</span><span class="sc0"> </span><span class="sc11">characteristics</span><span class="sc10">.</span><span class="sc11">get</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc2">//wait for ACK or time out
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">gattServerController</span><span class="sc10">.</span><span class="sc11">clearToSend</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">//update characteristic value and notify of change.
</span><span class="sc0">                </span><span class="sc11">command</span><span class="sc10">.</span><span class="sc11">characteristic</span><span class="sc10">.</span><span class="sc11">setValue</span><span class="sc10">(</span><span class="sc11">command</span><span class="sc10">.</span><span class="sc11">value</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">gattServerController</span><span class="sc10">.</span><span class="sc11">notifyCharacteristic</span><span class="sc10">(</span><span class="sc11">command</span><span class="sc10">.</span><span class="sc11">characteristic</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">stopX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span>
</pre><div class="caption">Here we see part of the sensor event procedure that is called when the sensor reports new data. We check whether we can send a command or
                not, and send or store a Command for when we can send. My implementation simply checks for an ACK.</div>
            </div>
            <div class="smallSpace"></div>
            <div class="codeBoxN">
                <pre><span class="sc2">//method will be called be the BluetoothGattServerController class once an 'ACK' is received
</span><span class="sc0">    </span><span class="sc2">// from the rc car. If we have Commands within the buffer awaiting sending, send them.
</span><span class="sc0">    </span><span class="sc2">//          --currently we do not 'buffer' these commands as once the car does recover from
</span><span class="sc0">    </span><span class="sc2">//              a 'frozen' state, it is bombarded with move commands and not this is not desirable.
</span><span class="sc0">    </span><span class="sc16">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">notifyClearToSend</span><span class="sc10">(){</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">commandBuffer</span><span class="sc10">.</span><span class="sc11">size</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">){</span><span class="sc0">
            </span><span class="sc11">commandBuffer</span><span class="sc10">.</span><span class="sc11">get</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">).</span><span class="sc11">characteristic</span><span class="sc10">.</span><span class="sc11">setValue</span><span class="sc10">(</span><span class="sc11">commandBuffer</span><span class="sc10">.</span><span class="sc11">get</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">).</span><span class="sc11">value</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">gattServerController</span><span class="sc10">.</span><span class="sc11">notifyCharacteristic</span><span class="sc10">(</span><span class="sc11">commandBuffer</span><span class="sc10">.</span><span class="sc11">get</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">).</span><span class="sc11">characteristic</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">commandBuffer</span><span class="sc10">.</span><span class="sc11">remove</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span>
</pre><div class="caption">This is the method that is called when the BluetoothGattServerController recieves an ACK and is ready to send another command.</div>
            </div>
            <div class="space"></div>
            <h2>Conclusion</h2>
            <p>This app was very interesting to develop; I had no experience with Bluetooth Low Energy prior to developing the app so the learning of this protocol was 
            very interesting, though somewhat difficult as Android documentation on GattServers and how they operate is currently very limited. The communication protocol 
            works great when properly executed, I had to implement the ACK state scheme because the phone was pushing sensor events to the RC car so fast that the 
            microcontroller could not properly finish setting up the PWM for the drive wheels. Also learning the different callbacks of the GattServer class was a fun
            experience, though the Android docs could have been better. </p>

<p style="text-align:center;">
            <p style="text-align:center;">	<a href="https://raw.githubusercontent.com/dusanders/dusanders.github.io/master/ANDROID/Source/BTComm/MainActivity.java" target="_blank">Download MainActivity.java</a></p>
            <p style="text-align:center;"><a href="https://raw.githubusercontent.com/dusanders/dusanders.github.io/master/ANDROID/Source/BTComm/SensorController.java" target="_blank">Download SensorController.java</a></p>
            <p style="text-align:center;"><a href="https://raw.githubusercontent.com/dusanders/dusanders.github.io/master/ANDROID/Source/BTComm/BluetoothListAdapter.java" target="_blank">Download BluetoothListAdapter.java</a></p>
            <p style="text-align:center;"><a href="https://raw.githubusercontent.com/dusanders/dusanders.github.io/master/ANDROID/Source/BTComm/BluetoothLeScanCallback.java" target="_blank">Download BluetoothLeScanCallback.java</a></p>
            <p style="text-align:center;"><a href="https://raw.githubusercontent.com/dusanders/dusanders.github.io/master/ANDROID/Source/BTComm/BluetoothGattServerController.java" target="_blank">Download BluetoothGattServerController.java</a></p>
            <p style="text-align:center;">	<a href="https://github.com/dusanders/dusanders.github.io/tree/master/ANDROID/Source/BTComm/" target="_blank">View Source Files Folder</a></p>            <div id="footer">
                <div id="copyright">
                    <p>Copyright &copy; 2015 Dustin Anderson</p>
                </div>
                <div id="aboutButton">
                    <p><a href="../index.html">About</a></p>
                </div>
            </div>
    </div>
    <div id="sideBar">
        <ul id="sideBarList">
            <p style="text-align:center; text-decoration:underline;">Projects</p>
            <li class="sideBarItem" id="RingerWrangler"><a href="AndroidRingerWrangler.html">Ringer Wrangler</a></li>
            <li class="sideBarItem" id="DashCam"><a href="AndroidDashCam.html">Dash Cam</a></li>
            <li class="sideBarItem" id="BluetoothRc" style="color: #006600; cursor:default;">BTLE RC Car</li>
            <li class="sideBarItem" id="BluetoothShare"><a href="AndroidSensorApp.html">Sensor App</a></li>
        </ul>
    </div>
    <div id="menuBar">
        <ul id="menuList">
            <li class="menuItem"><a href="../CPP/CPP.html">C++</a></li>
            <li class="menuItem"><a href="../CSHARP/CSharp.html">C#</a></li>
            <li class="menuItem"><a href="../JAVA/Java.html">Java</a></li>
            <li class="menuItem"><a href="../ASM/ASM.html">Embedded Systems</a></li>
            <li class="menuItem" style="color: #80CC80;">Android</li>
        </ul>
    </div>
    </div><!--end container-->
</body>

</html>
